pipeline {
    agent any
    environment {
        IMAGE_NAME = "empweb-frontend"
        CONTAINER_NAME = "empweb-frontend-container"
        ANGULAR_APP_DIR = "./employee-project" // Adjust if your Angular project is in a different folder
        PORT = "4200"
    }
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main',
                    credentialsId: 'github-pat-angular',
                    url: 'https://github.com/sonalic163/employee-project.git'
            }
        }

        stage('Check Node & NPM') {
            steps {
                sh 'node -v'
                sh 'npm -v'
            }
        }

        stage('Install Dependencies') {
            steps {
                dir("${ANGULAR_APP_DIR}") {
                    sh 'npm install'
                }
            }
        }

        stage('Build Angular') {
            steps {
                dir("${ANGULAR_APP_DIR}") {
                    sh 'npm run build --prod'
                }
            }
        }

        stage('Build Docker Image') {
            steps {
              sh 'docker build -t empweb-frontend ./'
            }
        }

        stage('Stop Existing Container') {
            steps {
                sh """
                if [ \$(docker ps -aq -f name=${CONTAINER_NAME}) ]; then
                    docker stop ${CONTAINER_NAME} || true
                    docker rm ${CONTAINER_NAME} || true
                fi
                """
            }
        }

        stage('Run Docker Container') {
            steps {
                sh """
                docker run -d -p ${PORT}:80 --name ${CONTAINER_NAME} ${IMAGE_NAME}
                """
            }
        }
    }

    post {
        success {
            echo "Angular app built and container is running on port ${PORT}!"
        }
        failure {
            echo "Pipeline failed. Check logs for details."
        }
    }
}
